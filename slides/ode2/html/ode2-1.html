<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="description" content="App.E: Programming of differential equations">

<title>App.E: Programming of differential equations</title>


<style type="text/css">
/* bloodish style */

body {
  font-family: Helvetica, Verdana, Arial, Sans-serif;
  color: #404040;
  background: #ffffff;
}
h1 { font-size: 1.8em;  color: #8A0808; }
h2 { font-size: 1.6em;  color: #8A0808; }
h3 { font-size: 1.4em;  color: #8A0808; }
h4 { color: #8A0808; }
a { color: #8A0808; text-decoration:none; }
tt { font-family: "Courier New", Courier; }
/* pre style removed because it will interfer with pygments */
p { text-indent: 0px; }
hr { border: 0; width: 80%; border-bottom: 1px solid #aaa}
p.caption { width: 80%; font-style: normal; text-align: left; }
hr.figure { border: 0; width: 80%; border-bottom: 1px solid #aaa}
.alert-text-small   { font-size: 80%;  }
.alert-text-large   { font-size: 130%; }
.alert-text-normal  { font-size: 90%;  }
.alert {
  padding:8px 35px 8px 14px; margin-bottom:18px;
  text-shadow:0 1px 0 rgba(255,255,255,0.5);
  border:1px solid #bababa;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  color: #555;
  background-color: #f8f8f8;
  background-position: 10px 5px;
  background-repeat: no-repeat;
  background-size: 38px;
  padding-left: 55px;
  width: 75%;
 }
.alert-block {padding-top:14px; padding-bottom:14px}
.alert-block > p, .alert-block > ul {margin-bottom:1em}
.alert li {margin-top: 1em}
.alert-block p+p {margin-top:5px}
.alert-notice { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_notice.png); }
.alert-summary  { background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_summary.png); }
.alert-warning { background-image: url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_warning.png); }
.alert-question {background-image:url(https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_images/small_gray_question.png); }

div { text-align: justify; text-justify: inter-word; }
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [(u'How to solve any ordinary scalar differential equation',
               1,
               None,
               '___sec0'),
              (u'Examples on scalar differential equations (ODEs)',
               2,
               None,
               '___sec1'),
              (u"We shall write an ODE in a generic form: $u'=f(u,t)$",
               2,
               None,
               '___sec2'),
              (u'What is the $f(u,t)$?', 2, None, '___sec3'),
              (u'Such abstract $f$ functions are widely used in mathematics',
               2,
               None,
               '___sec4'),
              (u'We use finite difference approximations to derivatives to turn an ODE into a difference equation',
               2,
               None,
               '___sec5'),
              (u"The Forward Euler (or Euler's) method; idea",
               2,
               None,
               '___sec6'),
              (u"The Forward Euler (or Euler's) method; idea",
               2,
               None,
               '___sec7'),
              (u"The Forward Euler (or Euler's) method; mathematics",
               2,
               None,
               '___sec8'),
              (u'Illustration of the forward finite difference',
               2,
               None,
               '___sec9'),
              (u"Let's apply the method!", 2, None, '___sec10'),
              (u'An ODE needs an initial condition: $u(0)=U_0$',
               2,
               None,
               '___sec11'),
              (u'We continue solution by hand', 2, None, '___sec12'),
              (u'How accurate is our numerical method?', 2, None, '___sec13'),
              (u"What about the general case $u'=f(u,t)$?",
               2,
               None,
               '___sec14'),
              (u"We start with a specialized program for $u'=u$, $u(0)=U_0$",
               2,
               None,
               '___sec15'),
              (u"We start with a specialized program for $u'=u$, $u(0)=U_0$",
               2,
               None,
               '___sec16'),
              (u'The solution if we plot $u$ against $t$',
               2,
               None,
               '___sec17'),
              (u"The algorithm for the general ODE $u'=f(u,t)$",
               2,
               None,
               '___sec18'),
              (u"Implementation of the general algorithm for $u'=f(u,t)$",
               2,
               None,
               '___sec19'),
              (u'Example on using the function', 2, None, '___sec20'),
              (u'Now you can solve any ODE!', 2, None, '___sec21'),
              (u'Let us make a class instead of a function for solving ODEs',
               2,
               None,
               '___sec22'),
              (u'The code for a class for solving ODEs (part 1)',
               2,
               None,
               '___sec23'),
              (u'The code for a class for solving ODEs (part 2)',
               2,
               None,
               '___sec24'),
              (u'Alternative class code for solving ODEs (part 1)',
               2,
               None,
               '___sec25'),
              (u'Alternative class code for solving ODEs (part 2)',
               2,
               None,
               '___sec26'),
              (u'Verifying the class implementation; mathematics',
               2,
               None,
               '___sec27'),
              (u'Verifying the class implementation; implementation',
               2,
               None,
               '___sec28'),
              (u'Using a class to hold the right-hand side $f(u,t)$',
               2,
               None,
               '___sec29'),
              (u'Figure of the solution', 2, None, '___sec30'),
              (u'Numerical methods for ordinary differential equations',
               2,
               None,
               '___sec31'),
              (u'A superclass for ODE methods', 2, None, '___sec32'),
              (u'The superclass code', 2, None, '___sec33'),
              (u'Implementation of the Forward Euler method',
               2,
               None,
               '___sec34'),
              (u'The implementation of a Runge-Kutta method',
               2,
               None,
               '___sec35'),
              (u'The user should be able to check intermediate solutions and terminate the time stepping',
               2,
               None,
               '___sec36'),
              (u'Systems of differential equations (vector ODE)',
               1,
               None,
               '___sec37'),
              (u'Example on a system of ODEs (vector ODE)',
               2,
               None,
               '___sec38'),
              (u'The ODE system that is the final project in the course',
               2,
               None,
               '___sec39'),
              (u'Another example on a system of ODEs (vector ODE)',
               2,
               None,
               '___sec40'),
              (u'Making a flexible toolbox for solving ODEs',
               2,
               None,
               '___sec41'),
              (u'Vector notation for systems of ODEs: unknowns and equations',
               2,
               None,
               '___sec42'),
              (u'Vector notation for systems of ODEs: vectors',
               2,
               None,
               '___sec43'),
              (u'How to make class ODESolver work for systems of ODEs',
               2,
               None,
               '___sec44'),
              (u'The adjusted superclass code (part 1)', 2, None, '___sec45'),
              (u'The superclass code (part 2)', 2, None, '___sec46'),
              (u'Example on how to use the general class hierarchy',
               2,
               None,
               '___sec47'),
              (u'Alternative implementation of the $f$ function via a class',
               2,
               None,
               '___sec48'),
              (u'Throwing a ball; ODE model', 2, None, '___sec49'),
              (u'Throwing a ball; code', 2, None, '___sec50'),
              (u'Throwing a ball; results', 2, None, '___sec51'),
              (u'Logistic growth model; ODE and code overview',
               2,
               None,
               '___sec52'),
              (u'Logistic growth model; class Problem ($f$)',
               2,
               None,
               '___sec53'),
              (u'Logistic growth model; class Solver', 2, None, '___sec54'),
              (u'Logistic growth model; results', 2, None, '___sec55')]}
end of tocinfo -->

<body>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "AMS"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



    
<!-- ------------------- main content ---------------------- -->



<center><h1>App.E: Programming of differential equations</h1></center>  <!-- document title -->

<p>
<!-- author(s): Hans Petter Langtangen -->

<center>
<b>Hans Petter Langtangen</b> [1, 2]
</center>

<p>
<!-- institution(s) -->

<center>[1] <b>Simula Research Laboratory</b></center>
<center>[2] <b>University of Oslo, Dept. of Informatics</b></center>
<br>
<p>
<center><h4>Aug 15, 2015</h4></center> <!-- date -->
<br>
<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1 id="___sec0">How to solve any ordinary scalar differential equation </h1>

<p>
<!-- !bslidecell 00 0.4 -->
$$
\begin{align*}
{\color{red}u'(t)} &= \alpha {\color{red}u(t)}(1 - R^{-1}{\color{red}u(t)})\\
{\color{red}u(0)} &= U_0
\end{align*}
$$

<!-- !eslidecell -->

<p>
<!-- !bslidecell 01 -->
<center><p><img src="fig-ode2/logistic_func_mpl.png" align="bottom" width=400></p></center>
<!-- !eslidecell -->

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec1">Examples on scalar differential equations (ODEs) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Terminology:</b>
<p>

<ul>
 <li> <em>Scalar ODE</em>: a single ODE, one unknown function</li>
 <li> <em>Vector ODE</em> or <em>systems of ODEs</em>: several ODEs, several unknown functions</li>
</ul>
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Examples:</b>
<p>
$$
\begin{align*}
u'&=\alpha u\quad\hbox{exponential growth}\\
u'&=\alpha u\left(  1-\frac{u}{R}\right)\quad\hbox{logistic growth}\\
u' + b|u|u &= g\quad\hbox{falling body in fluid}
\end{align*}
$$
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec2">We shall write an ODE in a generic form: \( u'=f(u,t) \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>

<ul>
 <li> Our methods and software should be applicable to <em>any</em> ODE</li>
 <li> Therefore we need an abstract notation for an arbitrary ODE</li>
</ul>

$$ u^{\prime}(t) = f(u(t), t)$$
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
The three ODEs on the last slide correspond to

$$
\begin{align*}
f(u,t) &= \alpha u,\quad\hbox{exponential growth}\\
f(u,t) &= \alpha u\left(  1-\frac{u}{R}\right),\quad\hbox{logistic growth}\\
f(u,t) &= -b|u|u + g,\quad\hbox{body in fluid}
\end{align*}
$$
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Our task: write functions and classes that take \( f \) as input and
produce \( u \) as output
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec3">What is the \( f(u,t) \)? </h2>

<p>
<!-- !bpop -->
<div class="alert alert-block alert-block alert-text-normal">
<b>Problem:</b>
<p>
Given an ODE,

$$ \sqrt{u}u' - \alpha(t) u^{3/2}(1-\frac{u}{R(t)}) = 0,$$

what is the \( f(u,t) \)?
</div>

<!-- !epop -->

<p>
<!-- !bpop -->
<div class="alert alert-block alert-block alert-text-normal">
<b>Solution:</b>
<p>
The target form is \( u'=f(u,t) \), so we need to isolate \( u' \) on the
left-hand side:

$$ u' = \underbrace{\alpha(t) u(1-\frac{u}{R(t)})}_{f(u,t)} $$


</div>

<!-- !epop -->

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec4">Such abstract \( f \) functions are widely used in mathematics </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>We can make generic software for:</b>
<p>

<ul>
 <li> Numerical differentiation: \( f'(x) \)</li>
 <li> Numerical integration: \( \int_a^b f(x)dx \)</li>
 <li> Numerical solution of algebraic equations: \( f(x)=0 \)</li>
</ul>
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Applications:</b>
<p>

<ol>
<li> \( \frac{d}{dx} x^a\sin (wx) \): \( f(x)=x^a\sin (wx) \)</li>
<li> \( \int_{-1}^1 (x^2\tanh^{-1}x - (1+x^2)^{-1})dx \): \( f(x)=x^2\tanh^{-1}x - (1+x^2)^{-1} \), \( a=-1 \), \( b=1 \)</li>
<li> Solve \( x^4\sin x = \tan x \): \( f(x)=x^4\sin x - \tan x \)</li>
</ol>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec5">We use finite difference approximations to derivatives to turn an ODE into a difference equation </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>\( u'=f(u,t) \).</b>
<p>
Assume we have computed \( u \) at discrete time points
\( t_0,t_1,\ldots,t_k \). At \( t_k \) we have the ODE

$$ u'(t_k) = f(u(t_k),t_k) $$

<p>
Approximate \( u'(t_k) \) by a forward finite difference,

$$ u'(t_k)\approx \frac{u(t_{k+1})-u(t_k)}{\Delta t}$$

<p>
Insert in the ODE at \( t=t_k \):

$$ \frac{u(t_{k+1})-u(t_k)}{\Delta t} = f(u(t_k),t_k) $$

<p>
Terms with \( u(t_k) \) are known, and this is an algebraic (difference) equation
for \( u(t_{k+1}) \)
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec6">The Forward Euler (or Euler's) method; idea </h2>

<p>
<center><p><img src="fig-ode2/FE_comic_1.png" align="bottom" width=600></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec7">The Forward Euler (or Euler's) method; idea </h2>

<p>
<center><p><img src="fig-ode2/FE_comic_2.png" align="bottom" width=600></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec8">The Forward Euler (or Euler's) method; mathematics </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Solving with respect to \( u(t_{k+1}) \)
$$ u(t_{k+1}) = u(t_k) + \Delta t f(u(t_k), t_k)$$

<p>
This is a very simple formula that we can use repeatedly for
\( u(t_1) \), \( u(t_2) \), \( u(t_3) \) and so forth.
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Difference equation notation:</b>
<p>
Let \( u_k \) denote the numerical approximation to the exact solution \( u(t) \)
at \( t=t_k \).

$$ u_{k+1} = u_k + \Delta t f(u_k,t_k)$$

<p>
This is an ordinary difference equation we can solve!
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec9">Illustration of the forward finite difference </h2>

<p>
<center><p><img src="fig-ode2/fd_forward.png" align="bottom" width=500></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec10">Let's apply the method! </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Problem: The world's simplest ODE.</b>
<p>

$$ u' = u,\quad t\in (0,T] $$

<p>
Solve for \( u \) at \( t=t_k=k\Delta t \), \( k=0,1,2,\ldots,t_n \),
\( t_0=0 \), \( t_n=T \)
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Forward Euler method:</b>
<p>
$$ u_{k+1} = u_k + \Delta t\, f(u_k,t_k)$$
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Solution by hand:</b>
<p>
What is \( f \)? \( f(u,t)=u \)

$$ u_{k+1} = u_k + \Delta t f(u_k,t_k) = u_k + \Delta t u_k = (1+\Delta t)u_k$$

<p>
First step:
$$ u_1 = (1+\Delta t) u_0$$

but what is \( u_0 \)?
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec11">An ODE needs an initial condition: \( u(0)=U_0 \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Numerics:</b>
<p>
Any ODE \( u'=f(u,t) \) <em>must</em> have an initial condition \( u(0)=U_0 \), with
known \( U_0 \), otherwise we cannot start the method!
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Mathematics:</b>
<p>
In mathematics: \( u(0)=U_0 \) must be specified to get a unique solution.
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Example:</b>
<p>
$$ u'=u $$

Solution: \( u=Ce^t \) for any constant \( C \). Say \( u(0)=U_0 \): \( u=U_0e^t \).
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec12">We continue solution by hand </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Say \( U_0=2 \):

$$
\begin{align*}
u_1 &= (1+\Delta t) u_0 = (1+\Delta t) U_0 = (1+\Delta t)2 \\
u_2 &= (1+\Delta t) u_1 = (1+\Delta t) (1+\Delta t)2 = 2(1+\Delta t)^2\\
u_3 &= (1+\Delta t) u_2 = (1+\Delta t) 2(1+\Delta t)^2 = 2(1+\Delta t)^3\\
u_4 &= (1+\Delta t) u_3 = (1+\Delta t) 2(1+\Delta t)^3 = 2(1+\Delta t)^4\\
u_5 &= (1+\Delta t) u_4 = (1+\Delta t) 2(1+\Delta t)^4 = 2(1+\Delta t)^5\\
\vdots &= \vdots\\
u_k &= 2(1+\Delta t)^k
\end{align*}
$$

Actually, we found a formula for \( u_k \)! No need to program...
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec13">How accurate is our numerical method? </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>

<ul>
 <li> Exact solution: \( u(t)=2e^t \), \( u(t_k)=2e^{k\Delta t} = 2(e^{\Delta t})^k \)</li>
 <li> Numerical solution: \( u_k = 2(1+\Delta t)^k \)</li>
</ul>

When going from \( t_k \) to \( t_{k+1} \), the solution is amplified by a factor:

<ul>
 <li> Exact: \( u(t_{k+1}) = e^{\Delta t}u(t_k) \)</li>
 <li> Numerical: \( u_{k+1} = (1+\Delta t)u_k \)</li>
</ul>

Using Taylor series for \( e^x \) we see that

$$ e^{\Delta t} - (1+\Delta t) = 1 + \Delta t + \frac{\Delta t^2}{2}
+ frac{\Delta t^3}{6} + \cdots - (1+\Delta t) = frac{\Delta t^3}{6}
+ {\cal O}(\Delta t^4)$$

This error approaches 0 as \( \Delta t\rightarrow 0 \).
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec14">What about the general case \( u'=f(u,t) \)? </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Given any \( U_0 \):
$$
\begin{align*}
u_1 &= u_0 + \Delta t f(u_0, t_0)\\
u_2 &= u_1 + \Delta t f(u_1, t_1)\\
u_3 &= u_2 + \Delta t f(u_2, t_2)\\
u_4 &= u_3 + \Delta t f(u_3, t_3)\\
&\vdots
\end{align*}
$$

No general formula in this case...
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Rule of thumb:</b>
<p>
When hand calculations get boring, let's program!
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec15">We start with a specialized program for \( u'=u \), \( u(0)=U_0 \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Algorithm:</b>
<p>
Given \( \Delta t \) (<code>dt</code>) and \( n \)

<ul>
 <li> Create arrays <code>t</code> and <code>u</code> of length \( n+1 \)</li>
 <li> Set initial condition: <code>u[0]</code> = \( U_0 \), <code>t[0]=0</code></li>
 <li> For \( k=0,1,2,\ldots,n-1 \):</li>

<ul>
  <li> <code>t[k+1] = t[k] + dt</code></li>
  <li> <code>u[k+1] = (1 + dt)*u[k]</code></li>
</ul>

</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec16">We start with a specialized program for \( u'=u \), \( u(0)=U_0 \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Program:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">sys</span>

dt <span style="color: #666666">=</span> <span style="color: #008000">float</span>(sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>])
U0 <span style="color: #666666">=</span> <span style="color: #666666">1</span>
T <span style="color: #666666">=</span> <span style="color: #666666">4</span>
n <span style="color: #666666">=</span> <span style="color: #008000">int</span>(T<span style="color: #666666">/</span>dt)

t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n<span style="color: #666666">+1</span>)
u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n<span style="color: #666666">+1</span>)

t[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #666666">0</span>
u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> U0
<span style="color: #008000; font-weight: bold">for</span> k <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(n):
    t[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> t[k] <span style="color: #666666">+</span> dt
    u[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">+</span> dt)<span style="color: #666666">*</span>u[k]

<span style="color: #408080; font-style: italic"># plot u against t</span>
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec17">The solution if we plot \( u \) against \( t \) </h2>

<p>
\( \Delta t = 0.4 \) and \( \Delta t=0.2 \):
<br />
<br />

<p>
<center><p><img src="fig-ode2/FE_n_10_20.png" align="bottom" width=600></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec18">The algorithm for the general ODE \( u'=f(u,t) \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Algorithm:</b>
<p>
Given \( \Delta t \) (<code>dt</code>) and \( n \)

<ul>
 <li> Create arrays <code>t</code> and <code>u</code> of length \( n+1 \)</li>
 <li> Create array <code>u</code> to hold \( u_k \) and</li>
 <li> Set initial condition: <code>u[0]</code> = \( U_0 \), <code>t[0]=0</code></li>
 <li> For \( k=0,1,2,\ldots,n-1 \):</li>

<ul>
  <li> <code>u[k+1] = u[k] + dt*f(u[k], t[k])</code> <font color="red">(the only change!)</font></li>
  <li> <code>t[k+1] = t[k] + dt</code></li>
</ul>

</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec19">Implementation of the general algorithm for \( u'=f(u,t) \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>General function:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">ForwardEuler</span>(f, U0, T, n):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Solve u&#39;=f(u,t), u(0)=U0, with n steps until t=T.&quot;&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
    t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n<span style="color: #666666">+1</span>)
    u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n<span style="color: #666666">+1</span>)  <span style="color: #408080; font-style: italic"># u[k] is the solution at time t[k]</span>

    u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> U0
    t[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #666666">0</span>
    dt <span style="color: #666666">=</span> T<span style="color: #666666">/</span><span style="color: #008000">float</span>(n)

    <span style="color: #008000; font-weight: bold">for</span> k <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(n):
        t[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> t[k] <span style="color: #666666">+</span> dt
        u[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> u[k] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>f(u[k], t[k])

    <span style="color: #008000; font-weight: bold">return</span> u, t
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Magic:</b>
<p>
This simple function can solve any ODE (!)
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec20">Example on using the function </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Mathematical problem:</b>
<p>
Solve \( u'=u \), \( u(0)=1 \), for \( t\in [0,4] \),
with \( \Delta t = 0.4 \) <br />
Exact solution: \( u(t)=e^t \).
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Basic code:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(u, t):
    <span style="color: #008000; font-weight: bold">return</span> u

U0 <span style="color: #666666">=</span> <span style="color: #666666">1</span>
T <span style="color: #666666">=</span> <span style="color: #666666">3</span>
n <span style="color: #666666">=</span> <span style="color: #666666">30</span>
u, t <span style="color: #666666">=</span> ForwardEuler(f, U0, T, n)
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Compare exact and numerical solution:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">scitools.std</span> <span style="color: #008000; font-weight: bold">import</span> plot, exp
u_exact <span style="color: #666666">=</span> exp(t)
plot(t, u, <span style="color: #BA2121">&#39;r-&#39;</span>, t, u_exact, <span style="color: #BA2121">&#39;b-&#39;</span>,
     xlabel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;t&#39;</span>, ylabel<span style="color: #666666">=</span><span style="color: #BA2121">&#39;u&#39;</span>, legend<span style="color: #666666">=</span>(<span style="color: #BA2121">&#39;numerical&#39;</span>, <span style="color: #BA2121">&#39;exact&#39;</span>),
     title<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Solution of the ODE u&#39;=u, u(0)=1&quot;</span>)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec21">Now you can solve any ODE! </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Recipe:</b>
<p>

<ul>
 <li> Identify \( f(u,t) \) in your ODE</li>
 <li> Make sure you have an initial condition \( U_0 \)</li>
 <li> Implement the \( f(u,t) \) formula in a Python function <code>f(u, t)</code></li>
 <li> Choose \( \Delta t \) or no of steps \( n \)</li>
 <li> Call <code>u, t = ForwardEuler(f, U0, T, n)</code></li>
 <li> <code>plot(t, u)</code></li>
</ul>
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Warning:</b>
<p>
The Forward Euler method may give very inaccurate solutions if
\( \Delta t \) is not sufficiently small. For some problems
(like \( u''+u=0 \)) other methods should be used.
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec22">Let us make a class instead of a function for solving ODEs </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Usage of the class:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">method <span style="color: #666666">=</span> ForwardEuler(f, dt)
method<span style="color: #666666">.</span>set_initial_condition(U0, t0)
u, t <span style="color: #666666">=</span> method<span style="color: #666666">.</span>solve(T)
plot(t, u)
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>How?</b>
<p>

<ul>
  <li> Store \( f \), \( \Delta t \), and the sequences \( u_k \), \( t_k \) as attributes</li>
  <li> Split the steps in the <code>ForwardEuler</code> function into four methods:</li>

<ul>
     <li> the constructor (<code>__init__</code>)</li>
     <li> <code>set_initial_condition</code> for \( u(0)=U_0 \)</li>
     <li> <code>solve</code> for running the numerical time stepping</li>
     <li> <code>advance</code> for isolating the numerical updating formula <br />
       (new numerical methods just need a different <code>advance</code> method,
       the rest is the same)</li>
</ul>

</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec23">The code for a class for solving ODEs (part 1) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ForwardEuler_v1</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, f, dt):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>f, <span style="color: #008000">self</span><span style="color: #666666">.</span>dt <span style="color: #666666">=</span> f, dt

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_initial_condition</span>(<span style="color: #008000">self</span>, U0):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>U0 <span style="color: #666666">=</span> <span style="color: #008000">float</span>(U0)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec24">The code for a class for solving ODEs (part 2) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ForwardEuler_v1</span>:
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>, T):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compute solution for 0 &lt;= t &lt;= T.&quot;&quot;&quot;</span>
        n <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span><span style="color: #008000">self</span><span style="color: #666666">.</span>dt))  <span style="color: #408080; font-style: italic"># no of intervals</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n<span style="color: #666666">+1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n<span style="color: #666666">+1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #008000">float</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>U0)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>t[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #008000">float</span>(<span style="color: #666666">0</span>)

        <span style="color: #008000; font-weight: bold">for</span> k <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>n):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> k
            <span style="color: #008000">self</span><span style="color: #666666">.</span>t[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>t[k] <span style="color: #666666">+</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>dt
            <span style="color: #008000">self</span><span style="color: #666666">.</span>u[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>advance()
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">advance</span>(<span style="color: #008000">self</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Advance the solution one time step.&quot;&quot;&quot;</span>
        <span style="color: #408080; font-style: italic"># Create local variables to get rid of &quot;self.&quot; in</span>
        <span style="color: #408080; font-style: italic"># the numerical formula</span>
        u, dt, f, k, t <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>dt, <span style="color: #008000">self</span><span style="color: #666666">.</span>f, <span style="color: #008000">self</span><span style="color: #666666">.</span>k, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

        unew <span style="color: #666666">=</span> u[k] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>f(u[k], t[k])
        <span style="color: #008000; font-weight: bold">return</span> unew
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec25">Alternative class code for solving ODEs (part 1) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #408080; font-style: italic"># Idea: drop dt in the constructor.</span>
<span style="color: #408080; font-style: italic"># Let the user provide all time points (in solve).</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ForwardEuler</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, f):

        <span style="color: #408080; font-style: italic"># test that f is a function</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">callable</span>(f):
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">TypeError</span>(<span style="color: #BA2121">&#39;f is </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">, not a function&#39;</span> <span style="color: #666666">%</span> <span style="color: #008000">type</span>(f))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>f <span style="color: #666666">=</span> f

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_initial_condition</span>(<span style="color: #008000">self</span>, U0):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>U0 <span style="color: #666666">=</span> <span style="color: #008000">float</span>(U0)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>, time_points):
        <span style="color: #666666">...</span>
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec26">Alternative class code for solving ODEs (part 2) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ForwardEuler</span>:
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>, time_points):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compute u for t values in time_points list.&quot;&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>asarray(time_points)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(<span style="color: #008000">len</span>(time_points))

        <span style="color: #008000">self</span><span style="color: #666666">.</span>u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>U0

        <span style="color: #008000; font-weight: bold">for</span> k <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>t)<span style="color: #666666">-1</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> k
            <span style="color: #008000">self</span><span style="color: #666666">.</span>u[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>advance()
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">advance</span>(<span style="color: #008000">self</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Advance the solution one time step.&quot;&quot;&quot;</span>
        u, f, k, t <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>f, <span style="color: #008000">self</span><span style="color: #666666">.</span>k, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

        dt <span style="color: #666666">=</span> t[k<span style="color: #666666">+1</span>] <span style="color: #666666">-</span> t[k]
        unew <span style="color: #666666">=</span> u[k] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>f(u[k], t[k])
        <span style="color: #008000; font-weight: bold">return</span> unew
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec27">Verifying the class implementation; mathematics </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Mathematical problem:</b>
<p>
Important result: the numerical method (and most others) will
exactly reproduce \( u \) if it is linear in \( t \) (!):

$$
\begin{align*}
u(t) &= at+b = 0.2t + 3\\
h(t) &= u(t)\\
u'(t) &=0.2 + (u-h(t))^4,\quad u(0)=3,\quad t\in [0,3]
\end{align*}
$$

This \( u \) should be reproduced to machine precision for any \( \Delta t \).
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec28">Verifying the class implementation; implementation </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Code:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_ForwardEuler_against_linear_solution</span>():
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(u, t):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0.2</span> <span style="color: #666666">+</span> (u <span style="color: #666666">-</span> h(t))<span style="color: #666666">**4</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">h</span>(t):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">0.2*</span>t <span style="color: #666666">+</span> <span style="color: #666666">3</span>

    solver <span style="color: #666666">=</span> ForwardEuler(f)
    solver<span style="color: #666666">.</span>set_initial_condition(U0<span style="color: #666666">=3</span>)
    dt <span style="color: #666666">=</span> <span style="color: #666666">0.4</span>; T <span style="color: #666666">=</span> <span style="color: #666666">3</span>; n <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(<span style="color: #008000">float</span>(T)<span style="color: #666666">/</span>dt))
    time_points <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, n<span style="color: #666666">+1</span>)
    u, t <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>solve(time_points)
    u_exact <span style="color: #666666">=</span> h(t)
    diff <span style="color: #666666">=</span> np<span style="color: #666666">.</span>abs(u_exact <span style="color: #666666">-</span> u)<span style="color: #666666">.</span>max()
    tol <span style="color: #666666">=</span> <span style="color: #666666">1E-14</span>
    success <span style="color: #666666">=</span> diff <span style="color: #666666">&lt;</span> tol
    <span style="color: #008000; font-weight: bold">assert</span> success
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec29">Using a class to hold the right-hand side \( f(u,t) \) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Mathematical problem:</b>
<p>
$$ u^{\prime}(t)=\alpha u(t)\left(  1-\frac{u(t)}{R}\right),\quad u(0)=U_0,\quad t\in [0,40]$$
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Class for right-hand side \( f(u,t) \):</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Logistic</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, alpha, R, U0):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>alpha, <span style="color: #008000">self</span><span style="color: #666666">.</span>R, <span style="color: #008000">self</span><span style="color: #666666">.</span>U0 <span style="color: #666666">=</span> alpha, <span style="color: #008000">float</span>(R), U0

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__call__</span>(<span style="color: #008000">self</span>, u, t):   <span style="color: #408080; font-style: italic"># f(u,t)</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>alpha<span style="color: #666666">*</span>u<span style="color: #666666">*</span>(<span style="color: #666666">1</span> <span style="color: #666666">-</span> u<span style="color: #666666">/</span><span style="color: #008000">self</span><span style="color: #666666">.</span>R)
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Main program:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">problem <span style="color: #666666">=</span> Logistic(<span style="color: #666666">0.2</span>, <span style="color: #666666">1</span>, <span style="color: #666666">0.1</span>)
time_points <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, <span style="color: #666666">40</span>, <span style="color: #666666">401</span>)
method <span style="color: #666666">=</span> ForwardEuler(problem)
method<span style="color: #666666">.</span>set_initial_condition(problem<span style="color: #666666">.</span>U0)
u, t <span style="color: #666666">=</span> method<span style="color: #666666">.</span>solve(time_points)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec30">Figure of the solution </h2>

<p>
<center><p><img src="fig-ode2/logistic_func_mpl.png" align="bottom" width=600></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec31">Numerical methods for ordinary differential equations </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Forward Euler method:</b>
<p>
$$ u_{k+1} = u_k + \Delta t\, f(u_k, t_k) $$
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>4th-order Runge-Kutta method:</b>
<p>
$$ u_{k+1} = u_k + {1\over 6}\left( K_1 + 2K_2 + 2K_3 + K_4\right)$$


$$
\begin{align*}
K_1 &= \Delta t\,f(u_k, t_k)\\
K_2 &= \Delta t\,f(u_k + {1\over2}K_1, t_k + {1\over2}\Delta t)\\
K_3 &= \Delta t\,f(u_k + {1\over2}K_2, t_k + {1\over2}\Delta t)\\
K_4 &= \Delta t\,f(u_k + K3, t_k + \Delta t)
\end{align*}
$$

<p>
And lots of other methods! How to program a wide collection of methods?
Use object-oriented programming!
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec32">A superclass for ODE methods </h2>

<p>
<!-- !bpop -->
<div class="alert alert-block alert-block alert-text-normal">
<b>Common tasks for ODE solvers:</b>
<p>

<ul>
  <li> Store the solution \( u_k \) and the corresponding time levels \( t_k \), \( k=0,1,2,\ldots,n \)</li>
  <li> Store the right-hand side function \( f(u,t) \)</li>
  <li> Set and store the initial condition</li>
  <li> Run the loop over all time steps</li>
</ul>
</div>

<!-- !epop -->

<p>
<!-- !bpop -->
<div class="alert alert-block alert-block alert-text-normal">
<b>Principles:</b>
<p>

<ul>
  <li> Common data and functionality are placed in superclass <code>ODESolver</code></li>
  <li> Isolate the numerical updating formula in a method <code>advance</code></li>
  <li> Subclasses, e.g., <code>ForwardEuler</code>, just implement the specific numerical formula in <code>advance</code></li>
</ul>
</div>

<!-- !epop -->

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec33">The superclass code </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, f):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>f <span style="color: #666666">=</span> f

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">advance</span>(<span style="color: #008000">self</span>):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Advance solution one time step.&quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">NotImplementedError</span>  <span style="color: #408080; font-style: italic"># implement in subclass</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_initial_condition</span>(<span style="color: #008000">self</span>, U0):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>U0 <span style="color: #666666">=</span> <span style="color: #008000">float</span>(U0)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>, time_points):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>asarray(time_points)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(<span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>t))
        <span style="color: #408080; font-style: italic"># Assume that self.t[0] corresponds to self.U0</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>U0

        <span style="color: #408080; font-style: italic"># Time loop</span>
        <span style="color: #008000; font-weight: bold">for</span> k <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(n<span style="color: #666666">-1</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> k
            <span style="color: #008000">self</span><span style="color: #666666">.</span>u[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>advance()
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">advance</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">raise</span> NotImplemtedError <span style="color: #408080; font-style: italic"># to be impl. in subclasses</span>
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec34">Implementation of the Forward Euler method </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Subclass code:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ForwardEuler</span>(ODESolver):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">advance</span>(<span style="color: #008000">self</span>):
        u, f, k, t <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>f, <span style="color: #008000">self</span><span style="color: #666666">.</span>k, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

        dt <span style="color: #666666">=</span> t[k<span style="color: #666666">+1</span>] <span style="color: #666666">-</span> t[k]
        unew <span style="color: #666666">=</span> u[k] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>f(u[k], t)
        <span style="color: #008000; font-weight: bold">return</span> unew
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Application code for \( u'-u=0 \), \( u(0)=1 \), \( t\in [0,3] \), \( \Delta t=0.1 \):</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span> <span style="color: #008000; font-weight: bold">import</span> ForwardEuler
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test1</span>(u, t):
    <span style="color: #008000; font-weight: bold">return</span> u

method <span style="color: #666666">=</span> ForwardEuler(test1)
method<span style="color: #666666">.</span>set_initial_condition(U0<span style="color: #666666">=1</span>)
u, t <span style="color: #666666">=</span> method<span style="color: #666666">.</span>solve(time_points<span style="color: #666666">=</span>np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, <span style="color: #666666">3</span>, <span style="color: #666666">31</span>))
plot(t, u)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec35">The implementation of a Runge-Kutta method </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Subclass code:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">RungeKutta4</span>(ODESolver):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">advance</span>(<span style="color: #008000">self</span>):
        u, f, k, t <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>f, <span style="color: #008000">self</span><span style="color: #666666">.</span>k, <span style="color: #008000">self</span><span style="color: #666666">.</span>t

        dt <span style="color: #666666">=</span> t[k<span style="color: #666666">+1</span>] <span style="color: #666666">-</span> t[k]
        dt2 <span style="color: #666666">=</span> dt<span style="color: #666666">/2.0</span>
        K1 <span style="color: #666666">=</span> dt<span style="color: #666666">*</span>f(u[k], t)
        K2 <span style="color: #666666">=</span> dt<span style="color: #666666">*</span>f(u[k] <span style="color: #666666">+</span> <span style="color: #666666">0.5*</span>K1, t <span style="color: #666666">+</span> dt2)
        K3 <span style="color: #666666">=</span> dt<span style="color: #666666">*</span>f(u[k] <span style="color: #666666">+</span> <span style="color: #666666">0.5*</span>K2, t <span style="color: #666666">+</span> dt2)
        K4 <span style="color: #666666">=</span> dt<span style="color: #666666">*</span>f(u[k] <span style="color: #666666">+</span> K3, t <span style="color: #666666">+</span> dt)
        unew <span style="color: #666666">=</span> u[k] <span style="color: #666666">+</span> (<span style="color: #666666">1/6.0</span>)<span style="color: #666666">*</span>(K1 <span style="color: #666666">+</span> <span style="color: #666666">2*</span>K2 <span style="color: #666666">+</span> <span style="color: #666666">2*</span>K3 <span style="color: #666666">+</span> K4)
        <span style="color: #008000; font-weight: bold">return</span> unew
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Application code (same as for ForwardEuler):</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span> <span style="color: #008000; font-weight: bold">import</span> RungeKutta4
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test1</span>(u, t):
    <span style="color: #008000; font-weight: bold">return</span> u

method <span style="color: #666666">=</span> RungeKutta4(test1)
method<span style="color: #666666">.</span>set_initial_condition(U0<span style="color: #666666">=1</span>)
u, t <span style="color: #666666">=</span> method<span style="color: #666666">.</span>solve(time_points<span style="color: #666666">=</span>np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, <span style="color: #666666">3</span>, <span style="color: #666666">31</span>))
plot(t, u)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec36">The user should be able to check intermediate solutions and terminate the time stepping </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>

<ul>
 <li> Sometimes a property of the solution determines when to stop the solution process: e.g., when \( u < 10^{-7}\approx 0 \).</li>
 <li> Extension: <code>solve(time_points, terminate)</code></li>
 <li> <code>terminate(u, t, step_no)</code> is called at every time step, is user-defined,
   and returns <code>True</code> when the time stepping should be terminated</li>
 <li> Last computed solution is <code>u[step_no]</code> at time <code>t[step_no]</code></li>
</ul>

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">terminate</span>(u, t, step_no):
    eps <span style="color: #666666">=</span> <span style="color: #666666">1.0E-6</span>                     <span style="color: #408080; font-style: italic"># small number</span>
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">abs</span>(u[step_no,<span style="color: #666666">0</span>]) <span style="color: #666666">&lt;</span> eps   <span style="color: #408080; font-style: italic"># close enough to zero?</span>
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h1 id="___sec37">Systems of differential equations (vector ODE) </h1>

<p>
<!-- !bslidecell 00 0.3 -->
$$
\begin{align*}
u' &= v\\
v' &= -u\\
u(0) &= 1\\
v(0) &= 0
\end{align*}
$$

<!-- !eslidecell -->

<p>
<!-- !bslidecell 01 0.7 -->
<center><p><img src="fig-ode2/cos_sin.png" align="bottom" width=500></p></center>
<!-- !eslidecell -->

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec38">Example on a system of ODEs (vector ODE) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Two ODEs with two unknowns \( u(t) \) and \( v(t) \):

$$
\begin{align*}
   u'(t) &= v(t)\\
   v'(t) &= -u(t)
\end{align*}
$$

<p>
Each unknown must have an initial condition, say

$$ u(0)=0,\quad v(0)=1 $$

<p>
In this case, one can derive the exact solution to be

$$ u(t)=\sin (t),\quad v(t)=\cos (t)$$

<p>
Systems of ODEs appear frequently in physics, biology, finance, ...
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec39">The ODE system that is the final project in the course </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Model for spreading of a disease in a population:

$$
\begin{align*}
S' &= - \beta SI\\
I' &= \beta SI -\nu R\\
R' &= \nu I
\end{align*}
$$

<p>
Initial conditions:

$$
\begin{align*}
S(0) &= S_0\\
I(0) &= I_0\\
R(0) &= 0
\end{align*}
$$
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec40">Another example on a system of ODEs (vector ODE) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Second-order ordinary differential equation, for a spring-mass system
(from Newton's second law):

$$ mu'' + \beta u' + ku = 0,\quad u(0)=U_0,\ u'(0)=0$$

<p>
We can rewrite this as a system of two <em>first-order</em> equations, by
introducing two new unknowns

$$ u^{(0)}(t) \equiv u(t),\quad u^{(1)}(t) \equiv u'(t)$$

<p>
The first-order system is then

$$
\begin{align*}
{d\over dt} u^{(0)}(t) &= u^{(1)}(t)\\
{d\over dt} u^{(1)}(t) &= -m^{-1}\beta u^{(1)} - m^{-1}ku^{(0)}
\end{align*}
$$

<p>
Initial conditions: \( u^{(0)}(0) = U_0 \), \( u^{(1)}(0)=0 \)
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec41">Making a flexible toolbox for solving ODEs </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>

<ul>
  <li> For scalar ODEs we could make one general class hierarchy to solve
    &quot;all&quot; problems with a range of methods</li>
  <li> Can we easily extend class hierarchy to systems of ODEs?</li>
  <li> Yes!</li>
  <li> The example here can easily be extended to professional code
    (<a href="https://github.com/hplgit/odespy" target="_blank">Odespy</a>)</li>
</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec42">Vector notation for systems of ODEs: unknowns and equations </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
General software for any vector/scalar ODE demands a general
mathematical notation. We introduce \( n \) unknowns

$$ u^{(0)}(t), u^{(1)}(t), \ldots, u^{(n-1)}(t) $$

in a system of \( n \) ODEs:

$$
\begin{align*}
{d\over dt}u^{(0)} &= f^{(0)}(u^{(0)}, u^{(1)}, \ldots, u^{(n-1)}, t)\\
{d\over dt}u^{(1)} &= f^{(1)}(u^{(0)}, u^{(1)}, \ldots, u^{(n-1)}, t)\\
\vdots &=& \vdots\\
{d\over dt}u^{(n-1)} &= f^{(n-1)}(u^{(0)}, u^{(1)}, \ldots, u^{(n-1)}, t)
\end{align*}
$$
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec43">Vector notation for systems of ODEs: vectors </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
We can collect the \( u^{(i)}(t) \) functions and right-hand side functions \( f^{(i)} \) in vectors:

$$ u = (u^{(0)}, u^{(1)}, \ldots, u^{(n-1)})$$


$$ f = (f^{(0)}, f^{(1)}, \ldots, f^{(n-1)})$$

<p>
The first-order system can then be written

$$ u' = f(u, t),\quad u(0) = U_0$$

where \( u \) and \( f \) are vectors and \( U_0 \) is a vector of initial conditions
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>The magic of this notation:</b>
<p>
Observe that the notation makes a scalar ODE and a system look the same,
and we can easily make Python code that can handle both cases within
the same lines of code (!)
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec44">How to make class ODESolver work for systems of ODEs </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>

<ul>
  <li> Recall: ODESolver was written for a scalar ODE</li>
  <li> Now we want it to work for a system \( u'=f \), \( u(0)=U_0 \), where \( u \), \( f \) and \( U_0 \) are vectors (arrays)</li>
  <li> What are the problems?</li>
</ul>

Forward Euler applied to a system:

$$
\underbrace{u_{k+1}}_{\mbox{vector}} =
\underbrace{u_k}_{\mbox{vector}} +
\Delta t\, \underbrace{f(u_k, t_k)}_{\mbox{vector}}
$$

<p>
In Python code:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">unew <span style="color: #666666">=</span> u[k] <span style="color: #666666">+</span> dt<span style="color: #666666">*</span>f(u[k], t)
</pre></div>
<p>
where

<ul>
  <li> <code>u</code> is a two-dim. array (<code>u[k]</code> is a row)</li>
  <li> <code>f</code> is a function returning an array
    (all the right-hand sides \( f^{(0)},\ldots,f^{(n-1)} \))</li>
</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec45">The adjusted superclass code (part 1) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>To make ODESolver work for systems:</b>
<p>

<ul>
 <li> Ensure that <code>f(u,t)</code> returns an array. <br />
   This can be done be a general adjustment in the superclass!</li>
 <li> Inspect \( U_0 \) to see if it is a number or list/tuple and
   make corresponding <code>u</code> 1-dim or 2-dim array</li>
</ul>
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, f):
        <span style="color: #408080; font-style: italic"># Wrap user&#39;s f in a new function that always</span>
        <span style="color: #408080; font-style: italic"># converts list/tuple to array (or let array be array)</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>f <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> u, t: np<span style="color: #666666">.</span>asarray(f(u, t), <span style="color: #008000">float</span>)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_initial_condition</span>(<span style="color: #008000">self</span>, U0):
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(U0, (<span style="color: #008000">float</span>,<span style="color: #008000">int</span>)):  <span style="color: #408080; font-style: italic"># scalar ODE</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>neq <span style="color: #666666">=</span> <span style="color: #666666">1</span>                 <span style="color: #408080; font-style: italic"># no of equations</span>
            U0 <span style="color: #666666">=</span> <span style="color: #008000">float</span>(U0)
        <span style="color: #008000; font-weight: bold">else</span>:                            <span style="color: #408080; font-style: italic"># system of ODEs</span>
            U0 <span style="color: #666666">=</span> np<span style="color: #666666">.</span>asarray(U0)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>neq <span style="color: #666666">=</span> U0<span style="color: #666666">.</span>size           <span style="color: #408080; font-style: italic"># no of equations</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>U0 <span style="color: #666666">=</span> U0
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec46">The superclass code (part 2) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span>:
    <span style="color: #666666">...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>, time_points, terminate<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000; font-weight: bold">if</span> terminate <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">None</span>:
            terminate <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">lambda</span> u, t, step_no: <span style="color: #008000">False</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> np<span style="color: #666666">.</span>asarray(time_points)
        n <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>t<span style="color: #666666">.</span>size
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>neq <span style="color: #666666">==</span> <span style="color: #666666">1</span>:  <span style="color: #408080; font-style: italic"># scalar ODEs</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros(n)
        <span style="color: #008000; font-weight: bold">else</span>:              <span style="color: #408080; font-style: italic"># systems of ODEs</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>u <span style="color: #666666">=</span> np<span style="color: #666666">.</span>zeros((n,<span style="color: #008000">self</span><span style="color: #666666">.</span>neq))

        <span style="color: #408080; font-style: italic"># Assume that self.t[0] corresponds to self.U0</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>U0

        <span style="color: #408080; font-style: italic"># Time loop</span>
        <span style="color: #008000; font-weight: bold">for</span> k <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(n<span style="color: #666666">-1</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>k <span style="color: #666666">=</span> k
            <span style="color: #008000">self</span><span style="color: #666666">.</span>u[k<span style="color: #666666">+1</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>advance()
            <span style="color: #008000; font-weight: bold">if</span> terminate(<span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t, <span style="color: #008000">self</span><span style="color: #666666">.</span>k<span style="color: #666666">+1</span>):
                <span style="color: #008000; font-weight: bold">break</span>  <span style="color: #408080; font-style: italic"># terminate loop over k</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>u[:k<span style="color: #666666">+2</span>], <span style="color: #008000">self</span><span style="color: #666666">.</span>t[:k<span style="color: #666666">+2</span>]
</pre></div>
<p>
All subclasses from the scalar ODE works for systems as well
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec47">Example on how to use the general class hierarchy </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Spring-mass system formulated as a system of ODEs:</b>
<p>
$$ mu'' + \beta u' + ku = 0,\quad u(0),\ u'(0)\hbox{ known}$$


$$
\begin{align*}
u^{(0)} &= u,\quad u^{(1)} = u'\\
u(t) &= (u^{(0)}(t), u^{(1)}(t))\\
f(u,t)&=(u^{(1)}(t), -m^{-1}\beta u^{(1)} - m^{-1}ku^{(0)})\\
u'(t) &= f(u,t)
\end{align*}
$$
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Code defining the right-hand side:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">myf</span>(u, t):
    <span style="color: #408080; font-style: italic"># u is array with two components u[0] and u[1]:</span>
    <span style="color: #008000; font-weight: bold">return</span> [u[<span style="color: #666666">1</span>],
            <span style="color: #666666">-</span>beta<span style="color: #666666">*</span>u[<span style="color: #666666">1</span>]<span style="color: #666666">/</span>m <span style="color: #666666">-</span> k<span style="color: #666666">*</span>u[<span style="color: #666666">0</span>]<span style="color: #666666">/</span>m]
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec48">Alternative implementation of the \( f \) function via a class </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Better (no global variables):</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MyF</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, m, k, beta):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>m, <span style="color: #008000">self</span><span style="color: #666666">.</span>k, <span style="color: #008000">self</span><span style="color: #666666">.</span>beta <span style="color: #666666">=</span> m, k, beta

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__call__</span>(<span style="color: #008000">self</span>, u, t):
        m, k, beta <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>m, <span style="color: #008000">self</span><span style="color: #666666">.</span>k, <span style="color: #008000">self</span><span style="color: #666666">.</span>beta
        <span style="color: #008000; font-weight: bold">return</span> [u[<span style="color: #666666">1</span>], <span style="color: #666666">-</span>beta<span style="color: #666666">*</span>u[<span style="color: #666666">1</span>]<span style="color: #666666">/</span>m <span style="color: #666666">-</span> k<span style="color: #666666">*</span>u[<span style="color: #666666">0</span>]<span style="color: #666666">/</span>m]
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Main program:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span> <span style="color: #008000; font-weight: bold">import</span> ForwardEuler
<span style="color: #408080; font-style: italic"># initial condition:</span>
U0 <span style="color: #666666">=</span> [<span style="color: #666666">1.0</span>, <span style="color: #666666">0</span>]
f <span style="color: #666666">=</span> MyF(<span style="color: #666666">1.0</span>, <span style="color: #666666">1.0</span>, <span style="color: #666666">0.0</span>)   <span style="color: #408080; font-style: italic"># u&#39;&#39; + u = 0 =&gt; u(t)=cos(t)</span>
solver <span style="color: #666666">=</span> ForwardEuler(f)
solver<span style="color: #666666">.</span>set_initial_condition(U0)

T <span style="color: #666666">=</span> <span style="color: #666666">4*</span>pi; dt <span style="color: #666666">=</span> pi<span style="color: #666666">/20</span>; n <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(T<span style="color: #666666">/</span>dt))
time_points <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, T, n<span style="color: #666666">+1</span>)
u, t <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>solve(time_points)

<span style="color: #408080; font-style: italic"># u is an array of [u0,u1] arrays, plot all u0 values:</span>
u0_values <span style="color: #666666">=</span> u[:,<span style="color: #666666">0</span>]
u0_exact <span style="color: #666666">=</span> cos(t)
plot(t, u0_values, <span style="color: #BA2121">&#39;r-&#39;</span>,  t, u0_exact, <span style="color: #BA2121">&#39;b-&#39;</span>)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec49">Throwing a ball; ODE model </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Newton's 2nd law for a ball's trajectory through air leads to

$$
\begin{align*}
{dx\over dt} &= v_x\\
{dv_x\over dt} &= 0\\
{dy\over dt} &= v_y\\
{dv_y\over dt} &= -g
\end{align*}
$$

Air resistance is neglected but can easily be added!

<ul>
  <li> 4 ODEs with 4 unknowns:</li>

<ul>
    <li> the ball's position \( x(t) \), \( y(t) \)</li>
    <li> the velocity \( v_x(t) \), \( v_y(t) \)</li>
</ul>

</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec50">Throwing a ball; code </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Define the right-hand side:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f</span>(u, t):
    x, vx, y, vy <span style="color: #666666">=</span> u
    g <span style="color: #666666">=</span> <span style="color: #666666">9.81</span>
    <span style="color: #008000; font-weight: bold">return</span> [vx, <span style="color: #666666">0</span>, vy, <span style="color: #666666">-</span>g]
</pre></div>

</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Main program:</b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">ODESolver</span> <span style="color: #008000; font-weight: bold">import</span> ForwardEuler
<span style="color: #408080; font-style: italic"># t=0: prescribe x, y, vx, vy</span>
x <span style="color: #666666">=</span> y <span style="color: #666666">=</span> <span style="color: #666666">0</span>                     <span style="color: #408080; font-style: italic"># start at the origin</span>
v0 <span style="color: #666666">=</span> <span style="color: #666666">5</span>;  theta <span style="color: #666666">=</span> <span style="color: #666666">80*</span>pi<span style="color: #666666">/180</span>    <span style="color: #408080; font-style: italic"># velocity magnitude and angle</span>
vx <span style="color: #666666">=</span> v0<span style="color: #666666">*</span>cos(theta)
vy <span style="color: #666666">=</span> v0<span style="color: #666666">*</span>sin(theta)
<span style="color: #408080; font-style: italic"># Initial condition:</span>
U0 <span style="color: #666666">=</span> [x, vx, y, vy]

solver<span style="color: #666666">=</span> ForwardEuler(f)
solver<span style="color: #666666">.</span>set_initial_condition(u0)
time_points <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, <span style="color: #666666">1.2</span>, <span style="color: #666666">101</span>)
u, t <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>solve(time_points)

<span style="color: #408080; font-style: italic"># u is an array of [x,vx,y,vy] arrays, plot y vs x:</span>
x <span style="color: #666666">=</span> u[:,<span style="color: #666666">0</span>];  y <span style="color: #666666">=</span> u[:,<span style="color: #666666">2</span>]
plot(x, y)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec51">Throwing a ball; results </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
Comparison of exact and Forward Euler solutions
</div>


<p>
<center><p><img src="fig-ode2/oo_ode_apps_ball.png" align="bottom" width=600></p></center>

<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec52">Logistic growth model; ODE and code overview </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Model:</b>
<p>
$$ u' = \alpha u(1 - u/{\color{red}R(t)}),\quad u(0)=U_0 $$

\( R \) is the maximum population size,
which can vary with changes in the environment over time
</div>


<p>
<div class="alert alert-block alert-block alert-text-normal">
<b>Implementation features:</b>
<p>

<ul>
  <li> Class Problem holds &quot;all physics&quot;: \( \alpha \), \( R(t) \), \( U_0 \), \( T \) (end time), \( f(u,t) \) in ODE</li>
  <li> Class Solver holds &quot;all numerics&quot;: \( \Delta t \), solution method; solves the problem and plots the solution</li>
  <li> Solve for \( t\in [0,T] \) but terminate when \( |u-R| < \hbox{tol} \)</li>
</ul>
</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec53">Logistic growth model; class Problem (\( f \)) </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Problem</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, alpha, R, U0, T):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>alpha, <span style="color: #008000">self</span><span style="color: #666666">.</span>R, <span style="color: #008000">self</span><span style="color: #666666">.</span>U0, <span style="color: #008000">self</span><span style="color: #666666">.</span>T <span style="color: #666666">=</span> alpha, R, U0, T

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__call__</span>(<span style="color: #008000">self</span>, u, t):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return f(u, t).&quot;&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>alpha<span style="color: #666666">*</span>u<span style="color: #666666">*</span>(<span style="color: #666666">1</span> <span style="color: #666666">-</span> u<span style="color: #666666">/</span><span style="color: #008000">self</span><span style="color: #666666">.</span>R(t))

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">terminate</span>(<span style="color: #008000">self</span>, u, t, step_no):
        <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Terminate when u is close to R.&quot;&quot;&quot;</span>
        tol <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>R<span style="color: #666666">*0.01</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">abs</span>(u[step_no] <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>R) <span style="color: #666666">&lt;</span> tol

problem <span style="color: #666666">=</span> Problem(alpha<span style="color: #666666">=0.1</span>, R<span style="color: #666666">=500</span>, U0<span style="color: #666666">=2</span>, T<span style="color: #666666">=130</span>)
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec54">Logistic growth model; class Solver </h2>

<p>
<div class="alert alert-block alert-block alert-text-normal">
<b></b>
<p>
<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Solver</span>:
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, problem, dt,
                 method<span style="color: #666666">=</span>ODESolver<span style="color: #666666">.</span>ForwardEuler):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>problem, <span style="color: #008000">self</span><span style="color: #666666">.</span>dt <span style="color: #666666">=</span> problem, dt
        <span style="color: #008000">self</span><span style="color: #666666">.</span>method <span style="color: #666666">=</span> method

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">solve</span>(<span style="color: #008000">self</span>):
        solver <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>method(<span style="color: #008000">self</span><span style="color: #666666">.</span>problem)
        solver<span style="color: #666666">.</span>set_initial_condition(<span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>U0)
        n <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">round</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T<span style="color: #666666">/</span><span style="color: #008000">self</span><span style="color: #666666">.</span>dt))
        t_points <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linspace(<span style="color: #666666">0</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>T, n<span style="color: #666666">+1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>u, <span style="color: #008000">self</span><span style="color: #666666">.</span>t <span style="color: #666666">=</span> solver<span style="color: #666666">.</span>solve(t_points,
                                      <span style="color: #008000">self</span><span style="color: #666666">.</span>problem<span style="color: #666666">.</span>terminate)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plot</span>(<span style="color: #008000">self</span>):
        plot(<span style="color: #008000">self</span><span style="color: #666666">.</span>t, <span style="color: #008000">self</span><span style="color: #666666">.</span>u)

problem <span style="color: #666666">=</span> Problem(alpha<span style="color: #666666">=0.1</span>, U0<span style="color: #666666">=2</span>, T<span style="color: #666666">=130</span>,
                  R<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">lambda</span> t: <span style="color: #666666">500</span> <span style="color: #008000; font-weight: bold">if</span> t <span style="color: #666666">&lt;</span> <span style="color: #666666">60</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">100</span>)
solver <span style="color: #666666">=</span> Solver(problem, dt<span style="color: #666666">=1.</span>)
solver<span style="color: #666666">.</span>solve()
solver<span style="color: #666666">.</span>plot()
<span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;max u:&#39;</span>, solver<span style="color: #666666">.</span>u<span style="color: #666666">.</span>max()
</pre></div>

</div>


<p>
<!-- !split --><br><br><br><br><br><br><br><br>

<h2 id="___sec55">Logistic growth model; results </h2>

<p>
<center><p><img src="fig-ode2/oo_ode_apps_logistic_varying_R.png" align="bottom" width=600></p></center>

<!-- ------------------- end of main content --------------- -->


</body>
</html>
    

